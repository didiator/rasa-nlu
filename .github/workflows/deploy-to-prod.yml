name: Deploy Rasa NLU to PROD

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      train_model:
        description: 'Rasa Model trainieren? (Bei neuen GerÃ¤ten/Intents/Entities)'
        required: true
        type: boolean
        default: false

jobs:
  deploy:
    name: Deploy Rasa NLU to PROD Server
    runs-on: [self-hosted, dgl-global]
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
      
      - name: Deploy Files
        run: |
          # Runner lÃ¤uft auf PROD - direkt kopieren
          mkdir -p ~/rasa-nlu
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='venv' \
            --exclude='__pycache__' \
            --exclude='*.pyc' \
            --exclude='models/*' \
            $GITHUB_WORKSPACE/ ~/rasa-nlu/
          
          echo "âœ… Files deployed"
      
      - name: Setup Python Environment
        run: |
          cd ~/rasa-nlu
          python3.10 -m venv venv
          source venv/bin/activate
          pip install --upgrade pip
          pip install rasa==3.6.21
          echo "âœ… Python environment ready"
      
      - name: Train Rasa Model
        if: github.event.inputs.train_model == 'true'
        run: |
          cd ~/rasa-nlu
          source venv/bin/activate
          echo "ðŸ”„ Training Rasa Model (neue GerÃ¤te/Intents/Entities)..."
          rasa train nlu
          echo "âœ… Model trained"
      
      - name: Install Systemd Service
        run: |
          sudo cp ~/rasa-nlu/rasa-nlu.service /etc/systemd/system/
          sudo systemctl daemon-reload
          sudo systemctl enable rasa-nlu
          sudo systemctl restart rasa-nlu
          echo "âœ… Service restarted"
      
      - name: Verify Deployment
        run: |
          echo "Service status:"
          sudo systemctl status rasa-nlu --no-pager -l | head -20
          
          echo ""
          echo "Deployed version:"
          cat ~/rasa-nlu/VERSION
      
      - name: Deployment Summary
        run: |
          echo "âœ… Rasa NLU Deployment to PROD successful!"
          echo "Release: ${{ github.event.release.tag_name }}"
          echo "Service: rasa-nlu.service running on PROD"
          echo "Port: 5005"
